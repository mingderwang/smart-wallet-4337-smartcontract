---
// استدعاء ملف الستايلات
import "../styles/global.css";
---

<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>WebAuthn Wallet Tester</title>
  </head>
  <body class="flex flex-col items-center justify-center min-h-screen bg-gray-100 p-4">
    <h1 class="text-2xl font-bold mb-8">WebAuthn Wallet Tester 🔒</h1>

    <div class="flex flex-col space-y-4">
      <button 
        id="registerButton" 
        class="px-6 py-3 bg-blue-500 text-white rounded hover:bg-blue-600"
      >
        Register (Create Passkey)
      </button>

      <button 
        id="loginButton" 
        class="px-6 py-3 bg-green-500 text-white rounded hover:bg-green-600"
      >
        Login (Sign In)
      </button>
    </div>

    <script type="module">
      // دالة تسجيل المستخدم باستخدام WebAuthn
      async function registerPasskey() {
        try {
          console.log("🔵 Starting Registration...");

          const publicKeyCredentialCreationOptions = {
            challenge: new Uint8Array(32), // Normally generated by the server
            rp: {
              name: "WebAuthn Wallet Tester",
            },
            user: {
              id: new Uint8Array(16),
              name: "testuser@example.com",
              displayName: "Test User",
            },
            pubKeyCredParams: [{ alg: -7, type: "public-key" }],
            authenticatorSelection: {
              userVerification: "preferred",
            },
            timeout: 60000,
            attestation: "direct",
          };

          const credential = await navigator.credentials.create({
            publicKey: publicKeyCredentialCreationOptions,
          });

          console.log("✅ Registered Credential:", credential);
          alert("✅ Registration successful!");

        } catch (error) {
          console.error("❌ Registration error:", error);
          alert("❌ Registration failed!");
        }
      }

      // دالة تسجيل الدخول باستخدام WebAuthn
      async function loginPasskey() {
        try {
          console.log("🟢 Starting Login...");

          const publicKeyCredentialRequestOptions = {
            challenge: new Uint8Array(32), // Normally generated by the server
            timeout: 60000,
            userVerification: "preferred",
          };

          const assertion = await navigator.credentials.get({
            publicKey: publicKeyCredentialRequestOptions,
          });

          console.log("✅ Assertion (Login) Successful:", assertion);

          // استخراج الداتا اللي هنحتاجها للسمارت كونتراكت
          const authenticatorData = new Uint8Array(assertion.response.authenticatorData);
          const clientDataJSON = new TextDecoder().decode(assertion.response.clientDataJSON);
          const signature = new Uint8Array(assertion.response.signature);

          console.log("🔹 Authenticator Data:", authenticatorData);
          console.log("🔹 Client Data JSON:", clientDataJSON);
          console.log("🔹 Signature:", signature);

          alert("✅ Login successful! Check console for details.");

        } catch (error) {
          console.error("❌ Login error:", error);
          alert("❌ Login failed!");
        }
      }

      // ربط الأزرار بالدوال
      document.getElementById("registerButton").addEventListener("click", registerPasskey);
      document.getElementById("loginButton").addEventListener("click", loginPasskey);
    </script>
  </body>
</html>
